--[[
	FLY GUI V3 - DÜZENLENMİŞ STABİL SÜRÜM
	Özellikler: R6/R15 desteği, Up/Down, hız ayarı, minimize
]]

-- Servisler
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer

-- Değişkenler
local flying = false
local speed = 10  -- başlangıç hızı
local maxSpeed = 50
local bodyGyro, bodyVelocity
var
local flightConnection
local upPressed = false
local downPressed = false

-- GUI oluşturma (tamamen ikinci scriptteki gibi, sadece ufak düzenlemeler)
local main = Instance.new("ScreenGui")
local Frame = Instance.new("Frame")
local up = Instance.new("TextButton")
local down = Instance.new("TextButton")
local onof = Instance.new("TextButton")
local TextLabel = Instance.new("TextLabel")
local plus = Instance.new("TextButton")
local speedLabel = Instance.new("TextLabel")
local mine = Instance.new("TextButton")
local closebutton = Instance.new("TextButton")
local mini = Instance.new("TextButton")
local mini2 = Instance.new("TextButton")

main.Name = "main"
main.Parent = LocalPlayer:WaitForChild("PlayerGui")
main.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
main.ResetOnSpawn = false

Frame.Parent = main
Frame.BackgroundColor3 = Color3.fromRGB(163, 255, 137)
Frame.BorderColor3 = Color3.fromRGB(103, 221, 213)
Frame.Position = UDim2.new(0.100320168, 0, 0.379746825, 0)
Frame.Size = UDim2.new(0, 190, 0, 57)
Frame.Active = true
Frame.Draggable = true

up.Name = "up"
up.Parent = Frame
up.BackgroundColor3 = Color3.fromRGB(79, 255, 152)
up.Size = UDim2.new(0, 44, 0, 28)
up.Font = Enum.Font.SourceSans
up.Text = "UP"
up.TextColor3 = Color3.fromRGB(0, 0, 0)
up.TextSize = 14.000

down.Name = "down"
down.Parent = Frame
down.BackgroundColor3 = Color3.fromRGB(215, 255, 121)
down.Position = UDim2.new(0, 0, 0.491228074, 0)
down.Size = UDim2.new(0, 44, 0, 28)
down.Font = Enum.Font.SourceSans
down.Text = "DOWN"
down.TextColor3 = Color3.fromRGB(0, 0, 0)
down.TextSize = 14.000

onof.Name = "onof"
onof.Parent = Frame
onof.BackgroundColor3 = Color3.fromRGB(255, 249, 74)
onof.Position = UDim2.new(0.702823281, 0, 0.491228074, 0)
onof.Size = UDim2.new(0, 56, 0, 28)
onof.Font = Enum.Font.SourceSans
onof.Text = "fly"
onof.TextColor3 = Color3.fromRGB(0, 0, 0)
onof.TextSize = 14.000

TextLabel.Parent = Frame
TextLabel.BackgroundColor3 = Color3.fromRGB(242, 60, 255)
TextLabel.Position = UDim2.new(0.469327301, 0, 0, 0)
TextLabel.Size = UDim2.new(0, 100, 0, 28)
TextLabel.Font = Enum.Font.SourceSans
TextLabel.Text = "FLY GUI V3"
TextLabel.TextColor3 = Color3.fromRGB(0, 0, 0)
TextLabel.TextScaled = true
TextLabel.TextWrapped = true

plus.Name = "plus"
plus.Parent = Frame
plus.BackgroundColor3 = Color3.fromRGB(133, 145, 255)
plus.Position = UDim2.new(0.231578946, 0, 0, 0)
plus.Size = UDim2.new(0, 45, 0, 28)
plus.Font = Enum.Font.SourceSans
plus.Text = "+"
plus.TextColor3 = Color3.fromRGB(0, 0, 0)
plus.TextScaled = true
plus.TextWrapped = true

speedLabel.Name = "speed"
speedLabel.Parent = Frame
speedLabel.BackgroundColor3 = Color3.fromRGB(255, 85, 0)
speedLabel.Position = UDim2.new(0.468421042, 0, 0.491228074, 0)
speedLabel.Size = UDim2.new(0, 44, 0, 28)
speedLabel.Font = Enum.Font.SourceSans
speedLabel.Text = tostring(speed)
speedLabel.TextColor3 = Color3.fromRGB(0, 0, 0)
speedLabel.TextScaled = true
speedLabel.TextWrapped = true

mine.Name = "mine"
mine.Parent = Frame
mine.BackgroundColor3 = Color3.fromRGB(123, 255, 247)
mine.Position = UDim2.new(0.231578946, 0, 0.491228074, 0)
mine.Size = UDim2.new(0, 45, 0, 29)
mine.Font = Enum.Font.SourceSans
mine.Text = "-"
mine.TextColor3 = Color3.fromRGB(0, 0, 0)
mine.TextScaled = true
mine.TextWrapped = true

closebutton.Name = "Close"
closebutton.Parent = Frame
closebutton.BackgroundColor3 = Color3.fromRGB(225, 25, 0)
closebutton.Font = "SourceSans"
closebutton.Size = UDim2.new(0, 45, 0, 28)
closebutton.Text = "X"
closebutton.TextSize = 30
closebutton.Position = UDim2.new(0, 0, -1, 27)

mini.Name = "minimize"
mini.Parent = Frame
mini.BackgroundColor3 = Color3.fromRGB(192, 150, 230)
mini.Font = "SourceSans"
mini.Size = UDim2.new(0, 45, 0, 28)
mini.Text = "-"
mini.TextSize = 40
mini.Position = UDim2.new(0, 44, -1, 27)

mini2.Name = "minimize2"
mini2.Parent = Frame
mini2.BackgroundColor3 = Color3.fromRGB(192, 150, 230)
mini2.Font = "SourceSans"
mini2.Size = UDim2.new(0, 45, 0, 28)
mini2.Text = "+"
mini2.TextSize = 40
mini2.Position = UDim2.new(0, 44, -1, 57)
mini2.Visible = false

-- Bildirim
game:GetService("StarterGui"):SetCore("SendNotification", {
	Title = "FLY GUI V3";
	Text = "Düzenlenmiş Stabil Sürüm";
	Icon = "rbxthumb://type=Asset&id=5107182114&w=150&h=150";
	Duration = 5;
})

-- Yardımcı fonksiyon: uçuş için doğru gövde parçasını bul (R6 için Torso, R15 için UpperTorso)
local function getTorso(character)
	if character:FindFirstChild("Torso") then
		return character.Torso
	elseif character:FindFirstChild("UpperTorso") then
		return character.UpperTorso
	end
	return nil
end

-- Uçuşu başlat
local function startFlying()
	local character = LocalPlayer.Character
	if not character then return end

	local humanoid = character:FindFirstChildWhichIsA("Humanoid")
	if not humanoid then return end

	local torso = getTorso(character)
	if not torso then return end

	-- PlatformStand aktif et ki karakter ayakta durmaya çalışmasın
	humanoid.PlatformStand = true

	-- BodyGyro: karakteri kameraya doğru döndürür
	bodyGyro = Instance.new("BodyGyro")
	bodyGyro.P = 5000  -- dönüş hassasiyeti (yüksek değer daha sert döner)
	bodyGyro.MaxTorque = Vector3.new(9e9, 9e9, 9e9)
	bodyGyro.CFrame = torso.CFrame
	bodyGyro.Parent = torso

	-- BodyVelocity: hareketi sağlar
	bodyVelocity = Instance.new("BodyVelocity")
	bodyVelocity.MaxForce = Vector3.new(9e9, 9e9, 9e9)
	bodyVelocity.Velocity = Vector3.zero
	bodyVelocity.Parent = torso

	-- RenderStepped bağlantısı
	flightConnection = RunService.RenderStepped:Connect(function()
		if not flying then return end
		if not character or not character.Parent then
			stopFlying()
			return
		end

		local camera = workspace.CurrentCamera
		if not camera then return end

		-- Kamera yönüne dön
		bodyGyro.CFrame = camera.CFrame

		-- Hareket vektörü (WASD)
		local moveDirection = humanoid.MoveDirection
		local velocity = Vector3.zero

		if moveDirection.Magnitude > 0 then
			-- Yatay hareket: kameranın lookVector ve rightVector'ı kullanılır
			-- moveDirection.Z: ileri/geri (W/S)
			-- moveDirection.X: sağ/sol (A/D)
			velocity = (camera.CFrame.LookVector * moveDirection.Z + camera.CFrame.RightVector * moveDirection.X) * speed
		end

		-- Dikey hareket (UP/DOWN butonları)
		if upPressed then
			velocity = velocity + Vector3.new(0, speed, 0)
		end
		if downPressed then
			velocity = velocity + Vector3.new(0, -speed, 0)
		end

		bodyVelocity.Velocity = velocity
	end)
end

-- Uçuşu durdur
local function stopFlying()
	if flightConnection then
		flightConnection:Disconnect()
		flightConnection = nil
	end
	if bodyGyro then
		bodyGyro:Destroy()
		bodyGyro = nil
	end
	if bodyVelocity then
		bodyVelocity:Destroy()
		bodyVelocity = nil
	end

	local character = LocalPlayer.Character
	if character then
		local humanoid = character:FindFirstChildWhichIsA("Humanoid")
		if humanoid then
			humanoid.PlatformStand = false
		end
	end
end

-- Toggle fly
onof.MouseButton1Click:Connect(function()
	flying = not flying
	if flying then
		onof.Text = "FLY ON"
		startFlying()
	else
		onof.Text = "fly"
		stopFlying()
	end
end)

-- UP butonu (basılı tutunca çalışsın)
up.MouseButton1Down:Connect(function()
	upPressed = true
end)
up.MouseButton1Up:Connect(function()
	upPressed = false
end)
up.MouseLeave:Connect(function()
	upPressed = false
end)

-- DOWN butonu
down.MouseButton1Down:Connect(function()
	downPressed = true
end)
down.MouseButton1Up:Connect(function()
	downPressed = false
end)
down.MouseLeave:Connect(function()
	downPressed = false
end)

-- Hız arttırma
plus.MouseButton1Click:Connect(function()
	speed = math.min(speed + 1, maxSpeed)
	speedLabel.Text = tostring(speed)
end)

-- Hız azaltma (minimum 1)
mine.MouseButton1Click:Connect(function()
	if speed > 1 then
		speed = speed - 1
		speedLabel.Text = tostring(speed)
	else
		speedLabel.Text = "MIN"
		task.wait(0.5)
		speedLabel.Text = tostring(speed)
	end
end)

-- Kapatma
closebutton.MouseButton1Click:Connect(function()
	stopFlying()
	main:Destroy()
end)

-- Minimize
mini.MouseButton1Click:Connect(function()
	up.Visible = false
	down.Visible = false
	onof.Visible = false
	plus.Visible = false
	speedLabel.Visible = false
	mine.Visible = false
	mini.Visible = false
	mini2.Visible = true
	Frame.BackgroundTransparency = 1
	closebutton.Position = UDim2.new(0, 0, -1, 57)
end)

mini2.MouseButton1Click:Connect(function()
	up.Visible = true
	down.Visible = true
	onof.Visible = true
	plus.Visible = true
	speedLabel.Visible = true
	mine.Visible = true
	mini.Visible = true
	mini2.Visible = false
	Frame.BackgroundTransparency = 0
	closebutton.Position = UDim2.new(0, 0, -1, 27)
end)

-- Karakter değiştiğinde uçuşu durdur (ölüm/respawn)
LocalPlayer.CharacterAdded:Connect(function()
	stopFlying()
	flying = false
	onof.Text = "fly"
end)

-- Script başlangıcında karakter varsa temizlik
if LocalPlayer.Character then
	stopFlying()
end
