local savedSpeed = 50

local function gui(character)

    local Players = game:GetService("Players")
    local RunService = game:GetService("RunService")
    local UserInputService = game:GetService("UserInputService")

    local player = Players.LocalPlayer
    local humanoid = character:WaitForChild("Humanoid")
    local HRP = character:WaitForChild("HumanoidRootPart")
    local Camera = workspace.CurrentCamera

    -- Rig detect
    local isR6 = humanoid.RigType == Enum.HumanoidRigType.R6
    local isR15 = humanoid.RigType == Enum.HumanoidRigType.R15

    local baseSpeed = savedSpeed
    local flySpeed = baseSpeed
    local flying = false
    local forwardHold = 0

    local inputFlags = {
        forward = false,
        back = false,
        left = false,
        right = false,
        up = false,
        down = false
    }

    local bodyVelocity = Instance.new("BodyVelocity")
    bodyVelocity.MaxForce = Vector3.new(9e9, 9e9, 9e9)
    bodyVelocity.P = 9e4

    local bodyGyro = Instance.new("BodyGyro")
    bodyGyro.MaxTorque = Vector3.new(9e9, 9e9, 9e9)
    bodyGyro.P = 9e4

    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "FlyScreenGui"
    screenGui.ResetOnSpawn = false
    screenGui.Parent = player:WaitForChild("PlayerGui")

    local toggleButton = Instance.new("TextButton")
    toggleButton.Text = "Fly OFF"
    toggleButton.Size = UDim2.new(0, 100, 0, 50)
    toggleButton.Position = UDim2.new(1, -220, 0, 10)
    toggleButton.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    toggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    toggleButton.Font = Enum.Font.GothamBold
    toggleButton.TextScaled = true
    toggleButton.Parent = screenGui

    local speedBox = Instance.new("TextBox")
    speedBox.Text = tostring(baseSpeed)
    speedBox.Size = UDim2.new(0, 100, 0, 50)
    speedBox.Position = UDim2.new(1, -110, 0, 10)
    speedBox.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    speedBox.TextColor3 = Color3.fromRGB(255, 255, 255)
    speedBox.Font = Enum.Font.GothamBold
    speedBox.TextScaled = true
    speedBox.Parent = screenGui

    local function newAnim(id)
        local anim = Instance.new("Animation")
        anim.AnimationId = "rbxassetid://" .. id
        return humanoid:LoadAnimation(anim)
    end

    -- Animations (R6 uyumlu, R15'te de genelde çalışır)
    local tracks = {
        forward = newAnim(90872539),
        up = newAnim(90872539),
        flyLow1 = newAnim(97169019),
        flyLow2 = newAnim(282574440),
        flyFast = newAnim(282574440),
        down = newAnim(233322916),
        idle = newAnim(97171309)
    }

    local function stopAll()
        for _, t in pairs(tracks) do
            t:Stop()
        end
    end

    local function startFlying()
        flying = true
        forwardHold = 0
        flySpeed = baseSpeed

        bodyVelocity.Parent = HRP
        bodyGyro.Parent = HRP

        humanoid.PlatformStand = true
    end

    local function stopFlying()
        flying = false

        bodyVelocity.Parent = nil
        bodyGyro.Parent = nil

        humanoid.PlatformStand = false
        stopAll()
    end

    toggleButton.MouseButton1Click:Connect(function()
        if flying then
            stopFlying()
            toggleButton.Text = "Fly OFF"
        else
            startFlying()
            toggleButton.Text = "Fly ON"
        end
    end)

    speedBox.FocusLost:Connect(function()
        local num = tonumber(speedBox.Text)
        if num and num > 0 then
            baseSpeed = num
            savedSpeed = num
        else
            speedBox.Text = tostring(baseSpeed)
        end
    end)

    UserInputService.InputBegan:Connect(function(input, gpe)
        if gpe then return end

        if input.KeyCode == Enum.KeyCode.W then inputFlags.forward = true end
        if input.KeyCode == Enum.KeyCode.S then inputFlags.back = true end
        if input.KeyCode == Enum.KeyCode.A then inputFlags.left = true end
        if input.KeyCode == Enum.KeyCode.D then inputFlags.right = true end
        if input.KeyCode == Enum.KeyCode.E then inputFlags.up = true end
        if input.KeyCode == Enum.KeyCode.Q then inputFlags.down = true end
    end)

    UserInputService.InputEnded:Connect(function(input)
        if input.KeyCode == Enum.KeyCode.W then inputFlags.forward = false end
        if input.KeyCode == Enum.KeyCode.S then inputFlags.back = false end
        if input.KeyCode == Enum.KeyCode.A then inputFlags.left = false end
        if input.KeyCode == Enum.KeyCode.D then inputFlags.right = false end
        if input.KeyCode == Enum.KeyCode.E then inputFlags.up = false end
        if input.KeyCode == Enum.KeyCode.Q then inputFlags.down = false end
    end)

    RunService.RenderStepped:Connect(function(dt)
        if not flying then return end

        local dir = Vector3.zero
        local camCF = Camera.CFrame

        if inputFlags.forward then dir += camCF.LookVector end
        if inputFlags.back then dir -= camCF.LookVector end
        if inputFlags.left then dir -= camCF.RightVector end
        if inputFlags.right then dir += camCF.RightVector end
        if inputFlags.up then dir += Vector3.yAxis end
        if inputFlags.down then dir -= Vector3.yAxis end

        if dir.Magnitude > 0 then
            dir = dir.Unit
        end

        bodyVelocity.Velocity = dir * flySpeed
        bodyGyro.CFrame = camCF

        -- simple animation logic
        if inputFlags.forward then
            forwardHold += dt

            if forwardHold > 2 then
                flySpeed = baseSpeed * 1.3
                if not tracks.flyFast.IsPlaying then
                    stopAll()
                    tracks.flyFast:Play()
                end
            else
                flySpeed = baseSpeed
                if not tracks.flyLow1.IsPlaying then
                    stopAll()
                    tracks.flyLow1:Play()
                    tracks.flyLow2:Play()
                end
            end

        elseif inputFlags.up then
            if not tracks.up.IsPlaying then
                stopAll()
                tracks.up:Play()
            end

        elseif inputFlags.down then
            if not tracks.down.IsPlaying then
                stopAll()
                tracks.down:Play()
            end

        else
            if not tracks.idle.IsPlaying then
                stopAll()
                tracks.idle:Play()
            end
        end
    end)

end


-- Character auto reload (ölünce bozulmaz)
local player = game:GetService("Players").LocalPlayer

if player.Character then
    gui(player.Character)
end

player.CharacterAdded:Connect(function(char)
    task.wait(1)
    gui(char)
end)
