-- SERVICES
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UIS = game:GetService("UserInputService")

local LocalPlayer = Players.LocalPlayer

-- VARIABLES
local speeds = 1
local nowe = false
local tpwalking = false

local bg, bv

-- GUI CREATE
local main = Instance.new("ScreenGui", LocalPlayer:WaitForChild("PlayerGui"))
main.Name = "main"
main.ResetOnSpawn = false

local Frame = Instance.new("Frame", main)
Frame.BackgroundColor3 = Color3.fromRGB(163, 255, 137)
Frame.Position = UDim2.new(0.1, 0, 0.38, 0)
Frame.Size = UDim2.new(0, 190, 0, 57)
Frame.Active = true
Frame.Draggable = true

local up = Instance.new("TextButton", Frame)
up.Size = UDim2.new(0,44,0,28)
up.Text = "UP"
up.BackgroundColor3 = Color3.fromRGB(79,255,152)

local down = Instance.new("TextButton", Frame)
down.Position = UDim2.new(0,0,0.49,0)
down.Size = UDim2.new(0,44,0,28)
down.Text = "DOWN"
down.BackgroundColor3 = Color3.fromRGB(215,255,121)

local onof = Instance.new("TextButton", Frame)
onof.Position = UDim2.new(0.7,0,0.49,0)
onof.Size = UDim2.new(0,56,0,28)
onof.Text = "FLY"

local plus = Instance.new("TextButton", Frame)
plus.Position = UDim2.new(0.23,0,0,0)
plus.Size = UDim2.new(0,45,0,28)
plus.Text = "+"

local mine = Instance.new("TextButton", Frame)
mine.Position = UDim2.new(0.23,0,0.49,0)
mine.Size = UDim2.new(0,45,0,29)
mine.Text = "-"

local speed = Instance.new("TextLabel", Frame)
speed.Position = UDim2.new(0.47,0,0.49,0)
speed.Size = UDim2.new(0,44,0,28)
speed.Text = speeds
speed.BackgroundColor3 = Color3.fromRGB(255,85,0)

-- FLY ENGINE
local function forceStates(hum)
	for _,state in pairs(Enum.HumanoidStateType:GetEnumItems()) do
		hum:SetStateEnabled(state, true)
	end
end

local function startFly()

	nowe = true

	local chr = LocalPlayer.Character
	local hum = chr:FindFirstChildWhichIsA("Humanoid")
	local root = chr:FindFirstChild("HumanoidRootPart")

	if not hum or not root then return end

	forceStates(hum)

	for i = 1, speeds do
		task.spawn(function()
			local hb = RunService.Heartbeat
			tpwalking = true
			while tpwalking and hb:Wait() and chr and hum and hum.Parent do
				if hum.MoveDirection.Magnitude > 0 then
					chr:TranslateBy(hum.MoveDirection)
				end
			end
		end)
	end

	chr.Animate.Disabled = true
	for _,v in next, hum:GetPlayingAnimationTracks() do
		v:AdjustSpeed(0)
	end

	bg = Instance.new("BodyGyro", root)
	bg.P = 9e4
	bg.maxTorque = Vector3.new(9e9,9e9,9e9)

	bv = Instance.new("BodyVelocity", root)
	bv.maxForce = Vector3.new(9e9,9e9,9e9)

	hum.PlatformStand = true

	task.spawn(function()
		local speedVal = 0
		local maxspeed = 50

		while nowe and hum.Health > 0 do
			RunService.RenderStepped:Wait()

			if hum.MoveDirection.Magnitude > 0 then
				speedVal = math.min(speedVal + 1, maxspeed)
				bv.velocity = workspace.CurrentCamera.CFrame.LookVector * speedVal
			else
				speedVal = 0
				bv.velocity = Vector3.new()
			end

			bg.cframe = workspace.CurrentCamera.CFrame
		end
	end)
end

local function stopFly()

	nowe = false
	tpwalking = false

	local chr = LocalPlayer.Character
	if not chr then return end

	local hum = chr:FindFirstChildWhichIsA("Humanoid")

	if hum then
		hum.PlatformStand = false
		chrr = chr
		if chr:FindFirstChild("Animate") then
			chr.Animate.Disabled = false
		end
	end

	if bg then bg:Destroy() end
	if bv then bv:Destroy() end

end

-- BUTTONS
onof.MouseButton1Click:Connect(function()

	if nowe then
		stopFly()
	else
		startFly()
	end

end)

-- UP / DOWN
local upLoop
up.MouseButton1Down:Connect(function()
	upLoop = true
	while upLoop do
		task.wait()
		local root = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
		if root then
			root.CFrame = root.CFrame * CFrame.new(0,1,0)
		end
	end
end)

up.MouseLeave:Connect(function()
	upLoop = false
end)

local downLoop
down.MouseButton1Down:Connect(function()
	downLoop = true
	while downLoop do
		task.wait()
		local root = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
		if root then
			root.CFrame = root.CFrame * CFrame.new(0,-1,0)
		end
	end
end)

down.MouseLeave:Connect(function()
	downLoop = false
end)

-- SPEED
plus.MouseButton1Click:Connect(function()
	speeds += 1
	speed.Text = speeds
end)

mine.MouseButton1Click:Connect(function()
	if speeds > 1 then
		speeds -= 1
		speed.Text = speeds
	end
end)

-- RESPAWN FIX
LocalPlayer.CharacterAdded:Connect(function(char)
	task.wait(0.7)
	local hum = char:FindFirstChildWhichIsA("Humanoid")
	if hum then
		hum.PlatformStand = false
	end
end)
